{"ast":null,"code":"var __assign = this && this.__assign || function () {\n  __assign = Object.assign || function (t) {\n    for (var s, i = 1, n = arguments.length; i < n; i++) {\n      s = arguments[i];\n      for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];\n    }\n    return t;\n  };\n  return __assign.apply(this, arguments);\n};\nvar __rest = this && this.__rest || function (s, e) {\n  var t = {};\n  for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0) t[p] = s[p];\n  if (s != null && typeof Object.getOwnPropertySymbols === \"function\") for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {\n    if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i])) t[p[i]] = s[p[i]];\n  }\n  return t;\n};\nvar __spreadArray = this && this.__spreadArray || function (to, from, pack) {\n  if (pack || arguments.length === 2) for (var i = 0, l = from.length, ar; i < l; i++) {\n    if (ar || !(i in from)) {\n      if (!ar) ar = Array.prototype.slice.call(from, 0, i);\n      ar[i] = from[i];\n    }\n  }\n  return to.concat(ar || Array.prototype.slice.call(from));\n};\nimport { useCallback, useMemo } from 'react';\nimport { useFormContext, useWatch } from 'react-hook-form';\nimport { useGetList, useGetManyAggregate } from '../../dataProvider';\nimport { useReferenceParams } from './useReferenceParams';\n/**\n * Prepare data for the ReferenceArrayInput components\n *\n * @example\n *\n * const { allChoices, availableChoices, selectedChoices, error, isFetching, isLoading } = useReferenceArrayInputController({\n *      record: { referenceIds: ['id1', 'id2']};\n *      reference: 'reference';\n *      resource: 'resource';\n *      source: 'referenceIds';\n * });\n *\n * @param {Object} props\n * @param {Object} props.record The current resource record\n * @param {string} props.reference The linked resource name\n * @param {string} props.resource The current resource name\n * @param {string} props.source The key of the linked resource identifier\n *\n * @param {Props} props\n *\n * @return {Object} controllerProps Fetched data and callbacks for the ReferenceArrayInput components\n */\nexport var useReferenceArrayInputController = function (props) {\n  var _a;\n  var debounce = props.debounce,\n    enableGetChoices = props.enableGetChoices,\n    filter = props.filter,\n    _b = props.page,\n    initialPage = _b === void 0 ? 1 : _b,\n    _c = props.perPage,\n    initialPerPage = _c === void 0 ? 25 : _c,\n    _d = props.sort,\n    initialSort = _d === void 0 ? {\n      field: 'id',\n      order: 'DESC'\n    } : _d,\n    _e = props.queryOptions,\n    queryOptions = _e === void 0 ? {} : _e,\n    reference = props.reference,\n    source = props.source;\n  var getValues = useFormContext().getValues;\n  // When we change the defaultValue of the child input using react-hook-form resetField function,\n  // useWatch does not seem to get the new value. We fallback to getValues to get it.\n  var value = (_a = useWatch({\n    name: source\n  })) !== null && _a !== void 0 ? _a : getValues(source);\n  var meta = queryOptions.meta,\n    otherQueryOptions = __rest(queryOptions, [\"meta\"]);\n  /**\n   * Get the records related to the current value (with getMany)\n   */\n  var _f = useGetManyAggregate(reference, {\n      ids: value || EmptyArray\n    }, {\n      enabled: value != null && value.length > 0\n    }),\n    referenceRecords = _f.data,\n    errorGetMany = _f.error,\n    isLoadingGetMany = _f.isLoading,\n    isFetchingGetMany = _f.isFetching,\n    refetchGetMany = _f.refetch;\n  var _g = useReferenceParams({\n      resource: reference,\n      page: initialPage,\n      perPage: initialPerPage,\n      sort: initialSort,\n      debounce: debounce,\n      filter: filter\n    }),\n    params = _g[0],\n    paramsModifiers = _g[1];\n  // filter out not found references - happens when the dataProvider doesn't guarantee referential integrity\n  var finalReferenceRecords = referenceRecords ? referenceRecords.filter(Boolean) : [];\n  var isGetMatchingEnabled = enableGetChoices ? enableGetChoices(params.filterValues) : true;\n  var _h = useGetList(reference, {\n      pagination: {\n        page: params.page,\n        perPage: params.perPage\n      },\n      sort: {\n        field: params.sort,\n        order: params.order\n      },\n      filter: __assign(__assign({}, params.filter), filter),\n      meta: meta\n    }, __assign({\n      retry: false,\n      enabled: isGetMatchingEnabled\n    }, otherQueryOptions)),\n    matchingReferences = _h.data,\n    total = _h.total,\n    pageInfo = _h.pageInfo,\n    errorGetList = _h.error,\n    isLoadingGetList = _h.isLoading,\n    isFetchingGetList = _h.isFetching,\n    refetchGetMatching = _h.refetch;\n  // We merge the currently selected records with the matching ones, otherwise\n  // the component displaying the currently selected records may fail\n  var finalMatchingReferences = matchingReferences && matchingReferences.length > 0 ? mergeReferences(matchingReferences, finalReferenceRecords) : finalReferenceRecords.length > 0 ? finalReferenceRecords : matchingReferences;\n  var refetch = useCallback(function () {\n    refetchGetMany();\n    refetchGetMatching();\n  }, [refetchGetMany, refetchGetMatching]);\n  var currentSort = useMemo(function () {\n    return {\n      field: params.sort,\n      order: params.order\n    };\n  }, [params.sort, params.order]);\n  return {\n    sort: currentSort,\n    allChoices: finalMatchingReferences,\n    availableChoices: matchingReferences,\n    selectedChoices: finalReferenceRecords,\n    displayedFilters: params.displayedFilters,\n    error: errorGetMany || errorGetList,\n    filter: filter,\n    filterValues: params.filterValues,\n    hideFilter: paramsModifiers.hideFilter,\n    isFetching: isFetchingGetMany || isFetchingGetList,\n    isLoading: isLoadingGetMany || isLoadingGetList,\n    page: params.page,\n    perPage: params.perPage,\n    refetch: refetch,\n    resource: reference,\n    setFilters: paramsModifiers.setFilters,\n    setPage: paramsModifiers.setPage,\n    setPerPage: paramsModifiers.setPerPage,\n    setSort: paramsModifiers.setSort,\n    showFilter: paramsModifiers.showFilter,\n    source: source,\n    total: total,\n    hasNextPage: pageInfo ? pageInfo.hasNextPage : total != null ? params.page * params.perPage < total : undefined,\n    hasPreviousPage: pageInfo ? pageInfo.hasPreviousPage : params.page > 1,\n    isFromReference: true\n  };\n};\nvar EmptyArray = [];\n// concatenate and deduplicate two lists of records\nvar mergeReferences = function (ref1, ref2) {\n  var res = __spreadArray([], ref1, true);\n  var ids = ref1.map(function (ref) {\n    return ref.id;\n  });\n  ref2.forEach(function (ref) {\n    if (!ids.includes(ref.id)) {\n      ids.push(ref.id);\n      res.push(ref);\n    }\n  });\n  return res;\n};","map":{"version":3,"mappings":"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","names":["useCallback","useMemo","useFormContext","useWatch","useGetList","useGetManyAggregate","useReferenceParams","useReferenceArrayInputController","props","enableGetChoices","filter","_b","initialPage","_c","initialPerPage","_d","initialSort","field","order","_e","queryOptions","reference","source","value","name","getValues","otherQueryOptions","ids","EmptyArray","enabled","length","referenceRecords","errorGetMany","isLoadingGetMany","isFetchingGetMany","refetchGetMany","resource","page","perPage","sort","debounce","params","paramsModifiers","finalReferenceRecords","Boolean","isGetMatchingEnabled","filterValues","pagination","meta","retry","matchingReferences","total","pageInfo","errorGetList","isLoadingGetList","isFetchingGetList","refetchGetMatching","finalMatchingReferences","mergeReferences","refetch","currentSort","allChoices","availableChoices","selectedChoices","displayedFilters","error","hideFilter","isFetching","isLoading","setFilters","setPage","setPerPage","setSort","showFilter","hasNextPage","undefined","hasPreviousPage","isFromReference","ref1","ref2","res","map","id","forEach","includes","ref","push"],"sourceRoot":"","sources":["../../../../src/controller/input/useReferenceArrayInputController.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"module"}